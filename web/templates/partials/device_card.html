{{ define "device_card" }}
<!-- Device Card Component -->
<div id="device-card-{{ .Item.Device.ID }}"
     class="card device-container">
    <article>
        <div class="device-card-grid">
            <!-- Header Section -->
            <div class="device-header">
                <header>
                    <h1>
                        <a href="{{ .Item.Device.ImgURL }}" target="_blank" class="device-link text-main">{{ .Item.Device.Name }}</a>
                        {{ if and .Item.Device.PinnedApp (ne (deref .Item.Device.PinnedApp) "") }}
                        <span class="badge badge-warning">
                            <span class="material-symbols-outlined icon-text">push_pin</span> {{ t .Localizer "Pinned:" }}
                            {{ $pinned := deref .Item.Device.PinnedApp }}
                            {{ $pinnedName := "" }}
                            {{ range .Item.Device.Apps }}
                            {{ if eq .Iname $pinned }}
                            {{ $pinnedName = printf "%s-%s" .Name .Iname }}
                            {{ end }}
                            {{ end }}
                            {{ if ne $pinnedName "" }}
                            {{ $pinnedName }}
                        {{ else }}
                            {{ $pinned }}
                            {{ end }}
                        </span>
                        {{ end }}
                    </h1>
                </header>
            </div>

            <!-- Preview & Info Section -->
            <div class="device-preview-section">
                <div class="app-img">
                    <img id="currentWebp-{{ .Item.Device.ID }}"
                         data-src="/devices/{{ .Item.Device.ID }}/current"
                         src="/devices/{{ .Item.Device.ID }}/current"
                         alt="{{ t .Localizer "Preview" }}">
                </div>
                <div class="text-muted text-sm">{{ t .Localizer "Currently Displaying App" }}</div>
                
                <div class="device-info-box">
                    <button class="btn btn-minimal device-info-toggle"
                            aria-expanded="false"
                            aria-controls="device-info-content-{{ .Item.Device.ID }}">
                        <span class="material-symbols-outlined icon-text text-sm">info</span> {{ t .Localizer "Device Info" }}
                    </button>
                    <div id="device-info-content-{{ .Item.Device.ID }}"
                         class="device-info-content">
                        <table class="device-info-table text-sm text-muted">
                            {{ if .Item.Device.Info.FirmwareVersion }}
                            <tr>
                                <td>{{ t $.Localizer "Firmware Version:" }}</td>
                                <td>{{ .Item.Device.Info.FirmwareVersion }}</td>
                            </tr>
                            {{ end }}
                            {{ if .Item.Device.Info.FirmwareType }}
                            <tr>
                                <td>{{ t $.Localizer "Firmware Type:" }}</td>
                                <td>{{ .Item.Device.Info.FirmwareType }}</td>
                            </tr>
                            {{ end }}
                            {{ if .Item.Device.Info.ProtocolVersion }}
                            <tr>
                                <td>{{ t $.Localizer "Protocol Version:" }}</td>
                                <td>{{ deref .Item.Device.Info.ProtocolVersion }}</td>
                            </tr>
                            {{ end }}
                            {{ if .Item.Device.Info.MACAddress }}
                            <tr>
                                <td>{{ t $.Localizer "MAC Address:" }}</td>
                                <td>{{ .Item.Device.Info.MACAddress }}</td>
                            </tr>
                            {{ end }}
                            <tr>
                                <td>{{ t $.Localizer "Protocol Type:" }}</td>
                                <td>{{ .Item.Device.Info.ProtocolType }}</td>
                            </tr>
                            {{ if .Item.Device.LastSeen }}
                            <tr>
                                <td>{{ t $.Localizer "Last Seen:" }}</td>
                                <td>{{ timeago $.Localizer .Item.Device.LastSeen }}</td>
                            </tr>
                            {{ end }}
                        </table>
                    </div>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="device-controls">
                <!-- Brightness -->
                <div class="control-group">
                    <label class="text-muted font-bold">{{ t .Localizer "Brightness" }} = <span id="brightnessValue-{{ .Item.Device.ID }}">{{ .Item.BrightnessUI }}</span></label>
                    <div class="brightness-panel" id="brightness-panel-{{ .Item.Device.ID }}">
                        {{ range $i := seq 0 5 }}
                        <button type="button"
                                class="brightness-btn {{ if eq $.Item.BrightnessUI $i }}active{{ end }}"
                                data-brightness="{{ $i }}"
                                onclick="setBrightness('{{ $.Item.Device.ID }}', {{ $i }})">{{ $i }}</button>
                        {{ end }}
                    </div>
                </div>

                <!-- Interval -->
                <div class="control-group">
                    <label for="default_interval-{{ .Item.Device.ID }}" class="text-muted font-bold">
                        {{ t .Localizer "App Cycle Time (Seconds)" }} = <span id="intervalValue-{{ .Item.Device.ID }}">{{.Item.Device.DefaultInterval }}</span> s
                    </label>
                    <input type="range"
                           name="default_interval"
                           id="default_interval-{{ .Item.Device.ID }}"
                           min="1"
                           max="30"
                           class="w-full"
                           value="{{ .Item.Device.DefaultInterval }}"
                           oninput="updateIntervalValue('{{ .Item.Device.ID }}', this.value)"
                           onmouseup="updateInterval('{{ .Item.Device.ID }}', this.value)">
                </div>

                <!-- Main Device Actions -->
                <div class="device-actions">
                    <a class="btn btn-primary"
                       href="/devices/{{ .Item.Device.ID }}/addapp">
                       <span class="material-symbols-outlined margin-right-xs">add_circle</span> {{ t .Localizer "Add App" }}
                    </a>
                    <a class="btn btn-primary"
                       href="/devices/{{ .Item.Device.ID }}/update">
                       <span class="material-symbols-outlined margin-right-xs">edit</span> {{ t .Localizer "Edit Device" }}
                    </a>
                    {{ if .Item.Device.Type.SupportsFirmware }}
                    <a class="btn btn-primary"
                       href="/devices/{{ .Item.Device.ID }}/firmware">
                       <span class="material-symbols-outlined margin-right-xs">memory</span> {{ t .Localizer "Firmware" }}
                    </a>
                    {{ end }}
                </div>
            </div>
        </div>

        <!-- View Toggle & Instructions -->
        <div class="view-toggle-row">
            <div class="view-toggle-container">
                <span class="text-bold margin-right-sm">{{ t .Localizer "View:" }}</span>
                <button id="listViewBtn-{{ .Item.Device.ID }}"
                        class="btn btn-secondary view-toggle-btn active"
                        onclick="switchToListView('{{ .Item.Device.ID }}')"
                        title="{{ t .Localizer "List View" }}">
                    <span class="material-symbols-outlined">view_list</span> {{ t .Localizer "List" }}
                </button>
                <button id="gridViewBtn-{{ .Item.Device.ID }}"
                        class="btn btn-secondary view-toggle-btn"
                        onclick="switchToGridView('{{ .Item.Device.ID }}')"
                        title="{{ t .Localizer "Grid View" }}">
                    <span class="material-symbols-outlined">grid_view</span> {{ t .Localizer "Grid" }}
                </button>
                <button id="collapsedViewBtn-{{ .Item.Device.ID }}"
                        class="btn btn-secondary view-toggle-btn"
                        onclick="switchToCollapsedView('{{ .Item.Device.ID }}')"
                        title="{{ t .Localizer "Collapsed View" }}">
                    <span class="material-symbols-outlined">expand_less</span> {{ t .Localizer "Collapsed" }}
                </button>
            </div>
            <div class="instruction-text text-muted text-italic text-sm">
                {{ t .Localizer "Drag apps to reorder or copy from/to another device" }}
            </div>
        </div>

        <!-- Apps List -->
        <div id="appsList-{{ .Item.Device.ID }}" class="visible apps-list-view">
            {{ range .Item.Device.Apps }}
            {{ template "app_card" (dict "App" . "Device" $.Item.Device "Localizer" $.Localizer "DevicesWithUIScales" $.DevicesWithUIScales) }}
            <hr class="list-view-separator">
            {{ end }}
        </div>
    </article>
</div>
{{ end }}
