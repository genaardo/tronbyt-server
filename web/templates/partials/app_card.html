{{ define "app_card" }}
<!-- App Card Component -->
<div class="card app-card"
     draggable="true"
     data-iname="{{ .App.Iname }}">
    <div class="app-card-content">
        <!-- Left: Preview Image -->
        <div class="app-preview">
            <div class="app-img">
                <img src="/devices/{{ .Device.ID }}/installations/{{ .App.Iname }}/preview"
                     alt="{{ t .Localizer "Preview" }}"
                     width="128"
                     height="64">
                {{ if .App.EmptyLastRender }}
                <div class="inactive-overlay">
                    <span class="inactive-badge-overlay">
                        <span class="material-symbols-outlined icon-text">warning</span> {{ t .Localizer "INACTIVE" }}
                    </span>
                </div>
                {{ end }}
            </div>
        </div>
        <!-- Middle: App Info and Action Buttons -->
        <div class="app-info">
            <div class="app-header">
                <h3>{{ .App.Name }}<span class="text-muted">-{{ .App.Iname }}</span></h3>
                <div class="app-status">
                    {{ if isPinned .Device .App.Iname }}
                    <span class="badge badge-warning">
                        <span class="material-symbols-outlined icon-text">push_pin</span> {{ t .Localizer "PINNED" }}
                    </span>
                {{ else }}
                    {{ if .App.Enabled }}
                    <span class="badge badge-success">
                        <span class="material-symbols-outlined icon-text">check_circle</span> {{ t .Localizer "ENABLED" }}
                    </span>
                {{ else }}
                    <span class="badge badge-danger">
                        <span class="material-symbols-outlined icon-text">cancel</span> {{ t .Localizer "DISABLED" }}
                    </span>
                    {{ end }}
                    {{ end }}
                    {{ if and .App.AutoPin (or (isPinned .Device .App.Iname) .App.Enabled) }}
                    <span class="badge badge-neutral">
                        <span class="material-symbols-outlined icon-text">auto_fix</span> {{ t .Localizer "AUTOPIN" }}
                    </span>
                    {{ end }}
                </div>
            </div>
            <div class="app-details text-muted">
                <p class="app-render-info">
                    {{ t .Localizer "Interval:" }} <span class="text-main">{{ .App.UInterval }} min</span> |
                    {{ if .App.EmptyLastRender }}
                    {{ t .Localizer "No output for:" }} {{ timesince .Localizer (or .App.LastSuccessfulRender .App.LastRender) }}
                {{ else }}
                    {{ t .Localizer "Last:" }} {{ timeago .Localizer .App.LastRender }}
                    ({{ t .Localizer "in" }} {{ duration .App.LastRenderDur }})
                    {{ end }}
                </p>
                {{ if ne .App.DisplayTime 0 }}
                <p>{{ t .Localizer "Display Time (secs):" }} {{ .App.DisplayTime }}</p>
                {{ end }}
                {{ if .App.Notes }}
                <p>{{ t .Localizer "Notes:" }} {{ .App.Notes }}</p>
                {{ end }}
            </div>
            <div class="app-actions">
                <!-- Primary Actions Row -->
                <div class="app-actions-primary">
                    <a class="btn btn-primary"
                       href="/devices/{{ .Device.ID }}/{{ .App.Iname }}/config">
                       <span class="material-symbols-outlined">edit</span> {{ t .Localizer "Edit" }}
                    </a>
                    {{ if eq .Device.Info.ProtocolType "WS" }}
                    <button class="btn btn-secondary"
                            onclick="previewApp('{{ .Device.ID }}', '{{ .App.Iname }}', null, this)">
                        <span class="material-symbols-outlined">play_arrow</span> {{ t .Localizer "Preview" }}
                    </button>
                    {{ end }}
                    <button class="btn btn-secondary"
                            onclick="duplicateApp('{{ .Device.ID }}', '{{ .App.Iname }}')">
                        <span class="material-symbols-outlined">content_copy</span> {{ t .Localizer "Duplicate" }}
                    </button>
                    {{ if gt (len .DevicesWithUIScales) 1 }}
                    <div class="btn btn-secondary copy-to-container">
                        <!-- Visual Label -->
                        <span class="material-symbols-outlined">content_copy</span>
                        <span>{{ t .Localizer "Copy to..." }}</span>
                        <span class="material-symbols-outlined">arrow_drop_down</span>
                        
                        <!-- Invisible Select Overlay -->
                        <select class="custom-select-overlay"
                                onchange="if(this.value) { duplicateAppToDevice('{{ .Device.ID }}', '{{ .App.Iname }}', this.value, null, false); this.selectedIndex=0; }">
                            <option value="" disabled selected>{{ t .Localizer "Copy to..." }}</option>
                            {{ range $item := .DevicesWithUIScales }}
                            {{ $target_device := $item.Device }}
                            {{ if ne $target_device.ID $.Device.ID }}
                            <option value="{{ $target_device.ID }}">{{ $target_device.Name }}</option>
                            {{ end }}
                            {{ end }}
                        </select>
                    </div>
                    {{ end }}
                    <button class="btn btn-danger"
                            onclick="deleteApp('{{ .Device.ID }}', '{{ .App.Iname }}', false, {{ t .Localizer "Delete App?" | json }})">
                        <span class="material-symbols-outlined">delete</span> {{ t .Localizer "Delete" }}
                    </button>
                </div>
                <!-- Secondary Actions Row -->
                <div class="app-actions-secondary">
                    <button class="btn btn-secondary btn-sm"
                            onclick="moveApp('{{ .Device.ID }}', '{{ .App.Iname }}', 'top')">
                        <span class="material-symbols-outlined">vertical_align_top</span> {{ t .Localizer "Top" }}
                    </button>
                    <button class="btn btn-secondary btn-sm"
                            onclick="moveApp('{{ .Device.ID }}', '{{ .App.Iname }}', 'bottom')">
                        <span class="material-symbols-outlined">vertical_align_bottom</span> {{ t .Localizer "Bottom" }}
                    </button>
                    {{ if isPinned .Device .App.Iname }}
                    <button class="btn btn-secondary btn-sm"
                            onclick="togglePin('{{ .Device.ID }}', '{{ .App.Iname }}')">
                        <span class="material-symbols-outlined">push_pin</span> {{ t .Localizer "Unpin" }}
                    </button>
                {{ else }}
                    <button class="btn btn-secondary btn-sm"
                            onclick="togglePin('{{ .Device.ID }}', '{{ .App.Iname }}')">
                        <span class="material-symbols-outlined">push_pin</span> {{ t .Localizer "Pin" }}
                    </button>
                    {{ if .App.Enabled }}
                    <button class="btn btn-secondary btn-sm"
                            onclick="toggleEnabled('{{ .Device.ID }}', '{{ .App.Iname }}')">
                        <span class="material-symbols-outlined">pause</span> {{ t .Localizer "Disable" }}
                    </button>
                {{ else }}
                    <button class="btn btn-secondary btn-sm"
                            onclick="toggleEnabled('{{ .Device.ID }}', '{{ .App.Iname }}')">
                        <span class="material-symbols-outlined">play_arrow</span> {{ t .Localizer "Enable" }}
                    </button>
                    {{ end }}
                    {{ end }}
                </div>
            </div>
        </div>
    </div>
</div>
{{ end }}
