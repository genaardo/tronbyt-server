{{ define "login" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "Log In" }}{{ end }}
{{ define "header" }}
<h1>{{ t .Localizer "Log In" }}</h1>
{{ end }}
{{ define "content" }}
<form method="post">
    <div style="margin-bottom: 15px;">
        <label for="username" style="display: block; margin-bottom: 5px;">{{ t .Localizer "Username" }}</label>
        <input name="username" id="username" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
    </div>
    
    <div style="margin-bottom: 15px;">
        <label for="password" style="display: block; margin-bottom: 5px;">{{ t .Localizer "Password" }}</label>
        <input type="password" name="password" id="password" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
    </div>
    
    <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" name="remember" id="remember">
        <label for="remember">{{ t .Localizer "Remember Me" }}</label>
    </div>
    
    <button type="submit" class="btn btn-primary">
        <span class="material-symbols-outlined">login</span> {{ t .Localizer "Log In" }}
    </button>
</form>
<div id="webauthn-login-container">
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
    <button onclick="loginWebAuthn()" class="btn btn-secondary">
        <span class="material-symbols-outlined">fingerprint</span> {{ t .Localizer "Sign in with Passkey" }}
    </button>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        if (!window.PublicKeyCredential || !navigator.credentials) {
            const el = document.getElementById('webauthn-login-container');
            if (el) el.style.display = 'none';
        }
    });

    function bufferDecode(value) {
        return Uint8Array.from(atob(value.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));
    }

    function bufferEncode(value) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "");
    }

    async function loginWebAuthn() {
        if (!window.PublicKeyCredential || !navigator.credentials) {
            alert("{{ t .Localizer "WebAuthn is not supported in this browser." }}");
            return;
        }
        try {
            const resp = await fetch('/auth/webauthn/login/begin');
            if (!resp.ok) throw new Error("Failed to begin login");

            const options = await resp.json();

            // Fix options
            options.publicKey.challenge = bufferDecode(options.publicKey.challenge);
            if (options.publicKey.allowCredentials) {
                options.publicKey.allowCredentials.forEach(c => {
                    c.id = bufferDecode(c.id);
                });
            }

            const credential = await navigator.credentials.get({
                publicKey: options.publicKey
            });

            const body = {
                id: credential.id,
                rawId: bufferEncode(credential.rawId),
                type: credential.type,
                response: {
                    authenticatorData: bufferEncode(credential.response.authenticatorData),
                    clientDataJSON: bufferEncode(credential.response.clientDataJSON),
                    signature: bufferEncode(credential.response.signature),
                    userHandle: credential.response.userHandle ? bufferEncode(credential.response.userHandle) : null,
                }
            };

            const finishResp = await fetch('/auth/webauthn/login/finish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (finishResp.ok) {
                window.location.href = '/';
            } else {
                alert("Login failed");
            }
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }
</script>
{{ end }}
